<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JsonPackingConverter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spritepacker-maven-plugin Maven Mojo</a> &gt; <a href="index.source.html" class="el_package">net.oneandone.maven.plugins.spritepacker.converters</a> &gt; <span class="el_source">JsonPackingConverter.java</span></div><h1>JsonPackingConverter.java</h1><pre class="source lang-java linenums">package net.oneandone.maven.plugins.spritepacker.converters;

import net.oneandone.maven.plugins.spritepacker.ImagePacking;
import net.oneandone.maven.plugins.spritepacker.NamedImage;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.logging.Log;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.map.SerializationConfig;
import org.codehaus.plexus.util.StringUtils;

import java.awt.Point;
import java.io.IOException;
import java.nio.file.Path;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.regex.Pattern;

/**
 * Converts ImagePacking to a JSON(P) file, with the result that each icon's details are available
 * via a named property which encapsulates w, h, x, y and xy as pixel values as well as storing
 * integer values for x, y, w and h in the property n.
 *
 * @author Robert Murphy, mklein
 */
public class JsonPackingConverter extends AbstractTextConverter {
    // JavaScript variable names may contain unicode letters, ascii digits, the dollar sign and the underscore, e.g.: &quot;_Ï‰$0&quot;
<span class="fc" id="L31">    public static final Pattern CHARS_NOT_ALLOWED_IN_VARIABLES = Pattern.compile(&quot;[^\\p{L}\\d_$]&quot;);</span>
<span class="fc" id="L32">    public static final Collection&lt;String&gt; RESERVED_WORDS = Collections.unmodifiableCollection(Arrays.asList(</span>
            &quot;break&quot;, &quot;case&quot;, &quot;catch&quot;, &quot;continue&quot;, &quot;debugger&quot;, &quot;default&quot;, &quot;delete&quot;, &quot;do&quot;, &quot;else&quot;,
            &quot;finally&quot;, &quot;for&quot;, &quot;function&quot;, &quot;if&quot;, &quot;in&quot;, &quot;instanceof&quot;, &quot;new&quot;, &quot;return&quot;, &quot;switch&quot;,
            &quot;this&quot;, &quot;throw&quot;, &quot;try&quot;, &quot;typeof&quot;, &quot;var&quot;, &quot;void&quot;, &quot;while&quot;, &quot;with&quot;, &quot;class&quot;, &quot;const&quot;,
            &quot;enum&quot;, &quot;export&quot;, &quot;extends&quot;, &quot;import&quot;, &quot;super&quot;, &quot;implements&quot;, &quot;interface&quot;, &quot;let&quot;,
            &quot;package&quot;, &quot;private&quot;, &quot;protected&quot;, &quot;public&quot;, &quot;static&quot;, &quot;yield&quot;, &quot;null&quot;, &quot;true&quot;,
            &quot;false&quot;, &quot;NaN&quot;, &quot;Infinity&quot;, &quot;undefined&quot;, &quot;eval&quot;, &quot;arguments&quot;, &quot;int&quot;, &quot;byte&quot;, &quot;char&quot;,
            &quot;goto&quot;, &quot;long&quot;, &quot;final&quot;, &quot;float&quot;, &quot;short&quot;, &quot;double&quot;, &quot;native&quot;, &quot;throws&quot;, &quot;boolean&quot;,
            &quot;abstract&quot;, &quot;volatile&quot;, &quot;transient&quot;, &quot;synchronized&quot;));

    protected static final int IMAGE_PROPERTY_COUNT = 6;
    protected static final int RAW_NUMBER_COUNT = 4;

    final String jsonpVar;

    /**
     * Create a JSON converter with output file json and optional JSONP variable jsonpVar.
     * @param json     the output JSON file to write to
     * @param jsonpVar optional JSONP variable name
     */
    public JsonPackingConverter(Path json, String jsonpVar) {
<span class="fc" id="L53">        super(json, &quot;JSON&quot;);</span>
<span class="fc" id="L54">        this.jsonpVar = fixJsonpVar(jsonpVar);</span>
<span class="fc" id="L55">    }</span>

    /**
     *Create output JSON string based on an ImagePacking.
     *
     * @param imageList     the list of images - must not be null
     * @param imagePacking  the ImagePacking to convert - must not be null
     * @param log           the log object to use
     * @return              String containing the JSON file contents
     * @throws MojoExecutionException when the JSON output cannot be generated
     */
    @Override
    protected String createOutput(List&lt;NamedImage&gt; imageList, ImagePacking imagePacking, Log log) throws MojoExecutionException {
<span class="fc" id="L68">        Map&lt;String, Object&gt; map = buildOutputMap(imageList, imagePacking);</span>

        try {
<span class="fc" id="L71">            ObjectMapper mapper = new ObjectMapper();</span>
<span class="fc" id="L72">            mapper.configure(SerializationConfig.Feature.INDENT_OUTPUT, true);</span>

<span class="fc" id="L74">            String out = mapper.writeValueAsString(map);</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">            return jsonpVar == null ? out : jsonpVar + &quot; = &quot; + out;</span>
<span class="fc" id="L76">        } catch (IOException e) {</span>
<span class="fc" id="L77">            throw new MojoExecutionException(&quot;Couldn't generate JSON data&quot;, e);</span>
        }
    }

    /**
     * Builds the output structure
     * @param imageList a list of images, defines the order of the entries in the map
     * @param imagePacking a packing of the images in the list
     * @return a map with an entry for each image
     */
    protected Map&lt;String, Object&gt; buildOutputMap(List&lt;NamedImage&gt; imageList, ImagePacking imagePacking) {
<span class="fc" id="L88">        Map&lt;String, Object&gt; map = new LinkedHashMap&lt;&gt;(imageList.size());</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        for (NamedImage n : imageList) {</span>
<span class="fc" id="L90">            Point position = imagePacking.getPosition(n);</span>

<span class="fc" id="L92">            Map&lt;String, Object&gt; props = new LinkedHashMap&lt;&gt;(IMAGE_PROPERTY_COUNT);</span>
<span class="fc" id="L93">            int x = position.x;</span>
<span class="fc" id="L94">            int y = position.y;</span>
<span class="fc" id="L95">            int width = n.getWidth();</span>
<span class="fc" id="L96">            int height = n.getHeight();</span>

<span class="fc" id="L98">            String xStr = intToPixel(-x);</span>
<span class="fc" id="L99">            String yStr = intToPixel(-y);</span>

<span class="fc" id="L101">            props.put(&quot;x&quot;, xStr);</span>
<span class="fc" id="L102">            props.put(&quot;y&quot;, yStr);</span>
<span class="fc" id="L103">            props.put(&quot;w&quot;, intToPixel(width));</span>
<span class="fc" id="L104">            props.put(&quot;h&quot;, intToPixel(height));</span>
<span class="fc" id="L105">            props.put(&quot;xy&quot;, xStr + &quot; &quot; + yStr);</span>

<span class="fc" id="L107">            Map&lt;String, Integer&gt; numbers = new LinkedHashMap&lt;&gt;(RAW_NUMBER_COUNT);</span>
<span class="fc" id="L108">            numbers.put(&quot;x&quot;, x);</span>
<span class="fc" id="L109">            numbers.put(&quot;y&quot;, y);</span>
<span class="fc" id="L110">            numbers.put(&quot;w&quot;, width);</span>
<span class="fc" id="L111">            numbers.put(&quot;h&quot;, height);</span>

<span class="fc" id="L113">            props.put(&quot;n&quot;, numbers);</span>

<span class="fc" id="L115">            map.put(n.getName(), props);</span>
<span class="fc" id="L116">        }</span>
<span class="fc" id="L117">        return map;</span>
    }

    /**
     * Remove invalid characters from JavaScript variable and avoid leading numbers or reserved words
     * by prefixing them with an underscore
     *
     * @param jsonpVar  the jsonpVar to fix
     * @return          the fixed jsonpVar
     */
    protected static String fixJsonpVar(String jsonpVar) {
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (StringUtils.isNotEmpty(jsonpVar)) {</span>
<span class="fc" id="L129">            String newVar = CHARS_NOT_ALLOWED_IN_VARIABLES.matcher(jsonpVar).replaceAll(&quot;&quot;);</span>
<span class="fc bfc" id="L130" title="All 6 branches covered.">            boolean needsPrefix = newVar.isEmpty() || hasLeadingNumber(newVar) || RESERVED_WORDS.contains(newVar);</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">            return needsPrefix ? &quot;_&quot; + newVar : newVar;</span>
        }
<span class="fc" id="L133">        return jsonpVar;</span>
    }

    /**
     * Check if a string starts with an arabic [0-9] digit character
     *
     * @param str   the string to check
     * @return      whether the string starts with [0-9]
     */
    private static boolean hasLeadingNumber(String str) {
<span class="fc bfc" id="L143" title="All 4 branches covered.">        return str.charAt(0) &gt;= '0' &amp;&amp; str.charAt(0) &lt;= '9';</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>