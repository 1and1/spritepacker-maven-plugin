<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SpritePacker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spritepacker-maven-plugin Maven Mojo</a> &gt; <a href="index.source.html" class="el_package">net.oneandone.maven.plugins.spritepacker</a> &gt; <span class="el_source">SpritePacker.java</span></div><h1>SpritePacker.java</h1><pre class="source lang-java linenums">package net.oneandone.maven.plugins.spritepacker;

import net.oneandone.maven.plugins.spritepacker.converters.CssPackingConverter;
import net.oneandone.maven.plugins.spritepacker.converters.JsonPackingConverter;
import net.oneandone.maven.plugins.spritepacker.converters.LessPackingConverter;
import net.oneandone.maven.plugins.spritepacker.converters.PackingConverter;
import net.oneandone.maven.plugins.spritepacker.converters.SpritesheetPackingConverter;
import org.apache.maven.plugin.AbstractMojo;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugins.annotations.Component;
import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.codehaus.plexus.util.FileUtils;
import org.codehaus.plexus.util.Scanner;
import org.sonatype.plexus.build.incremental.BuildContext;

import javax.imageio.ImageIO;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;


/**
 * Packs spritesheets from supplied images.
 *
 * @author Robert Murphy, mklein, ssiegler
 */
@Mojo(name = &quot;compile&quot;, defaultPhase = LifecyclePhase.PROCESS_SOURCES)
<span class="fc" id="L35">public class SpritePacker extends AbstractMojo {</span>

    /**
     * Output spritesheet image file
     */
    @Parameter(required = true)
    File output;

    /**
     * Optional output JSON(P) description file containing coordinates and dimensions
     */
    @Parameter
    File json;

    /**
     * Optional variable for JSONP files
     * e.g.
     * { image: {...} }
     * becomes
     * jsonpVar = { image: {...} }
     */
    @Parameter
    String jsonpVar;

    /**
     * Optional output CSS file containing coordinates and dimensions, where each icon is saved as its own class.
     */
    @Parameter
    File css;

    /**
     * Optional CSS class prefix. Default value is &quot;icon&quot;.
     */
    @Parameter
    String cssPrefix;

    /**
     * Optional output Less file containing coordinates and dimensions, where each icon is saved as position and size mixins.
     */
    @Parameter
    File less;

    /**
     * Optional Less namespace name.
     */
    @Parameter
    String lessNamespace;

    /**
     * The source directory containing the icons
     */
    @Parameter(required = true)
    File sourceDirectory;

    /**
     * List of files to include. Specified as fileset patterns which are relative to the source directory. Default is all files.
     */
<span class="fc" id="L92">    @Parameter</span>
    String[] includes = new String[] { &quot;**/*&quot; };

    /**
     * List of files to exclude. Specified as fileset patterns which are relative to the source directory.
     */
<span class="fc" id="L98">    @Parameter</span>
    String[] excludes = new String[] { };

    /**
     * Optional transparent padding added between images in spritesheet.
     */
    @Parameter(defaultValue = &quot;0&quot;)
    Integer padding;

    /**
     * Optionally force the sprite packer to always re-generate files regardless of whether new graphics were found.
     */
    @Parameter(defaultValue = &quot;false&quot;)
    Boolean forceOverwrite;

    /**
     * Optionally skip the execution of the plugin.
     */
    @Parameter(defaultValue = &quot;false&quot;)
    Boolean skip;

    @Component
    BuildContext buildContext;

    /**
     * Execute the MOJO.
     *
     * @throws MojoExecutionException if something unexpected occurs.
     */
    public void execute() throws MojoExecutionException {

<span class="fc bfc" id="L129" title="All 2 branches covered.">        if (skip) {</span>
<span class="fc" id="L130">            log(&quot;Execution of spritepacker was skipped.&quot;);</span>
<span class="fc" id="L131">            return;</span>
        }

<span class="fc" id="L134">        long startTime = System.currentTimeMillis();</span>

<span class="fc" id="L136">        List&lt;Path&gt; inputs = scanPaths(sourceDirectory, includes, excludes);</span>

        // Check if there are actually any inputs to do anything with
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (inputs.isEmpty()) {</span>
<span class="fc" id="L140">            log(&quot;No source images found.&quot;);</span>
<span class="fc" id="L141">            return;</span>
        }

<span class="fc" id="L144">        Path outputPath = fileToPath(output);</span>
<span class="fc" id="L145">        Path jsonPath = fileToPath(json);</span>
<span class="fc" id="L146">        Path cssPath = fileToPath(css);</span>
<span class="fc" id="L147">        Path lessPath = fileToPath(less);</span>

        // Load output files into an ArrayList
<span class="fc" id="L150">        List&lt;Path&gt; outputs = Arrays.asList(outputPath, jsonPath, cssPath, lessPath);</span>

        // If force overwrite not specified, and the JSON file is not being created for the first time,
        // and the output files were modified more recently than the input files, return.
        try {
<span class="pc bpc" id="L155" title="1 of 4 branches missed.">            if (!forceOverwrite &amp;&amp; !Utils.shouldWriteOutput(inputs, outputs)) {</span>
<span class="fc" id="L156">                log(&quot;No source images modified.&quot;);</span>
<span class="fc" id="L157">                return;</span>
            }
<span class="nc" id="L159">        } catch (IOException e) {</span>
<span class="nc" id="L160">            throw new MojoExecutionException(&quot;Could not check if output should be written.&quot;, e);</span>
<span class="fc" id="L161">        }</span>

<span class="fc" id="L163">        log(&quot;Loading &quot; + inputs.size() + &quot; images from &quot; + sourceDirectory.getAbsolutePath());</span>

        // Load images defined in input array
<span class="fc" id="L166">        List&lt;NamedImage&gt; images = loadImages(inputs);</span>

<span class="fc" id="L168">        log(&quot;Packing images...&quot;);</span>

        // Add packing information
<span class="fc" id="L171">        ImagePacking imagePacking = packImages(images);</span>

<span class="fc" id="L173">        List&lt;PackingConverter&gt; converters = Arrays.asList(new SpritesheetPackingConverter(outputPath),</span>
                                                          new JsonPackingConverter(jsonPath, jsonpVar),
                                                          new CssPackingConverter(cssPath, cssPrefix),
                                                          new LessPackingConverter(lessPath, lessNamespace));

<span class="fc bfc" id="L178" title="All 2 branches covered.">        for (PackingConverter converter : converters) {</span>
<span class="fc" id="L179">            executeConverter(images, imagePacking, converter);</span>
<span class="fc" id="L180">        }</span>

<span class="fc" id="L182">        long took = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L183">        log(&quot;Done - took &quot; + took + &quot;ms!&quot;);</span>

<span class="fc" id="L185">    }</span>

    // Allow tests to stub or verify the packing
    protected ImagePacking packImages(List&lt;NamedImage&gt; images) {
<span class="nc" id="L189">        return PackGrowing.fit(images, padding);</span>
    }

    // Allow tests to stub or verify converter execution
    protected void executeConverter(List&lt;NamedImage&gt; images, ImagePacking imagePacking, PackingConverter converter) throws MojoExecutionException {
<span class="fc" id="L194">        converter.convert(images, imagePacking, getLog());</span>
<span class="fc" id="L195">    }</span>

    /**
     * Convert a file to a path, or return null if the file is null
     *
     * @param file the file to convert to a path
     * @return the path that was converted from a file
     */
    protected Path fileToPath(File file) {
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        return (file == null) ? null : file.toPath();</span>
    }

    /**
     * Create a list of files within a source directory, including subdirectories,
     * that match the includes and excludes criteria
     *
     * @param sourceDirectory the source directory
     * @param includes        criterion for files to include
     * @param excludes        criterion for files to exclude
     * @return list of matching files
     */
    protected List&lt;Path&gt; scanPaths(File sourceDirectory, String[] includes, String[] excludes) {
<span class="fc" id="L217">        Scanner scanner = buildContext.newScanner(sourceDirectory, true);</span>
<span class="fc" id="L218">        scanner.setIncludes(includes);</span>
<span class="fc" id="L219">        scanner.setExcludes(excludes);</span>
<span class="fc" id="L220">        scanner.scan();</span>
<span class="fc" id="L221">        String[] fileNames = scanner.getIncludedFiles();</span>

        // sort files by path and name
<span class="fc" id="L224">        Arrays.sort(fileNames);</span>

<span class="fc" id="L226">        List&lt;Path&gt; paths = new ArrayList&lt;&gt;(fileNames.length);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">        for (String fileName : fileNames) {</span>
<span class="fc" id="L228">            paths.add(sourceDirectory.toPath().resolve(fileName));</span>
        }
<span class="fc" id="L230">        return paths;</span>
    }

    /**
     * Load list of image files as a list of NamedImages
     *
     * @param imageFiles the image files to load
     * @return the list of loaded NamedImages
     * @throws MojoExecutionException when any input image cannot be opened
     */
    protected List&lt;NamedImage&gt; loadImages(List&lt;Path&gt; imageFiles) throws MojoExecutionException {
        // Do not cache image data in temporary files.
<span class="fc" id="L242">        ImageIO.setUseCache(false);</span>

<span class="fc" id="L244">        List&lt;NamedImage&gt; images = new ArrayList&lt;&gt;(imageFiles.size());</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">        for (Path f : imageFiles) {</span>
<span class="pc" id="L246">            try (InputStream inputStream = Files.newInputStream(f)) {</span>
<span class="fc" id="L247">                String basename = FileUtils.removeExtension(f.getFileName().toString());</span>
<span class="fc" id="L248">                images.add(new NamedImage(ImageIO.read(inputStream), basename));</span>
<span class="pc bpc" id="L249" title="6 of 8 branches missed.">            } catch (IOException e) {</span>
<span class="fc" id="L250">                throw new MojoExecutionException(&quot;Failed to read image from file: &quot; + f.toAbsolutePath(), e);</span>
<span class="fc" id="L251">            }</span>
<span class="fc" id="L252">        }</span>
<span class="fc" id="L253">        return images;</span>
    }

    public void log(Object message) {
<span class="fc" id="L257">        getLog().info(message.toString());</span>
<span class="fc" id="L258">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>